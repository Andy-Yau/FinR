# FinEng Project
# FX Capital Guarantee pricing
# andyyau@connect.hku.hk

### DOCUMENTATION (code at bottom) ###


  #   The exchange rate model adopted is basic Vasicek model
  #   dr(t) = kappa*(theta - r(t))*dt + sigma*dW(t)
  #
  #   Estimation of parameters can be found here:
  #   http://www.math.ku.dk/~rolf/teaching/mfe04/MathFin.Vasicekestimation.R
  #   
  #
  #   Rates Notations (pr, cd, rf):
  #
  #   - participation rate (pr) is the higher rate the buyer can luckily get
  #   - certificate of deposite rate (cd) is the guaranteed rate if trigger is hit
  #   - risk-free rate (rf) is assumed to be accessible to all parties (incl. buyers)
  #
  #   According to the design, we infer pr > cd > rf 
  #   (the last inequality might not hold, give rising to variants)
  #   
  #
  #   List of functions:
  #   1.  [output] <- simulate([strike, tenor, graph])
  #       Usage: given trigger rate and maturity length, runs MCS and returns mean result
  #       Graph = 1: graphs rate evolution; Graph = 0: no graph wanted
  #   2.  strike_to_price()
  #       Usage: graphs the relationship between P (y-axis) and K (x-axis)
  #   3.  strike_to_ratio()
  #       Usage: graphs the relationship between Success Ratio (y-axis) and K (x-axis)

### MAIN CODE ###

library("quantmod")
rate <- matrix()
PF <- matrix()     # raw payoff vector
PF.d <- matrix()   # discounted payoff vector
PF.mean <- matrix()# mean of PF.d
ratio <- matrix()  # success ratio (= win.count/trials)

# inputs (strike and tenor are to be assigned in the valuation function)
I <- 100000       # base capital deposit
pr <- 0.05        # participation rate
cd <- 0.02        # CD rate (i.e. guaranteed rate)
rf <- 0.005       # continuous annual risk-free rate
dt <- 1/252       # discretized daily on 252 basis
trials <- 1000    # number of trial runs

# data retrieval (seems OANDA has failed)
  # obs <- getFX("USD/CNY", from = "2018-01-01", auto.assign = FALSE)
dataset <- read.csv(file="E:/YCH USB/HKU QFin/Year 4/Sem 2/financial engineering/Project/CHF_data.csv", header = TRUE)
data = dataset[-1,5]
n <- length(data)
data.lag = dataset[-n,5]

# parameter estimation
b <- (sum(data*data.lag)-sum(data)*sum(data.lag)/n)/(sum(data.lag^2)-(sum(data.lag)^2/n))
kappa <- -log(b)/dt
a <- sum(data)/n - b*sum(data.lag)/n
theta <- a/(1-b)
sigma <- sqrt(2*kappa*(sum((data-data.lag*b-a)^2)/n)/(1-b^2))

# product valuation function
simulate <- function(strike, tenor, graph){
  # initialize
  rate[1] <- data[1] # first rate equals first datum
  win.count <- 0 # counts how many "wins"
  loss.count <- 0 # counts how many "losses"
  for (j in 1:trials){
    indicator <- 0    # 0 if not hit, 1 if triggered; reset every trial
    # exchange rate evolution
    for (i in 1 : as.integer(tenor/dt)){
      rate[i+1] = rate[i] + kappa*(theta-rate[i])*dt + sigma*sqrt(dt)*rnorm(1)
      if (rate[i+1] > strike){
        indicator = indicator + 1 # triggered is hit, counted by indicator
      }
    }
    # contract payoff, and trigger count record
    if (indicator == 0){
      PF[j] <- I * (1 + pr) # not triggered, high rate (pr)
      win.count = win.count + 1
    } else {
      PF[j] <- I * (1 + cd) # triggered, guaranteed rate (cd)
      loss.count = loss.count + 1
    }
    PF.d[j] = PF[j]*exp(-rf*tenor) # discounting
  }
  # for validation only
  if(win.count + loss.count != trials){
    print("Win and loss do not sum up to total trials.")
    break
  }
  # graphing
  if(graph == 1){
    plot(rate, xlab = 'dt')
    lines(rate)
  }
  # output
  simulate = list(mean(PF.d), win.count/trials)
}

# for visualization, calculate and plot strike against product price
counter = 1
strike_to_price <- function(){
  for (K in seq(0.8, 1.2, by = 0.01)){
    PF.mean[counter] = simulate(K,1)[[1]]
    counter = counter + 1
  }
  plot(y = PF.mean, x = seq(0.8, 1.2, by = 0.01), xlab = 'Trigger Rate')
}

# for visualization, calculate and plot strike against success ratio
counter = 1
strike_to_ratio <- function(){
  for (K in seq(0.8, 1.2, by = 0.01)){
    ratio[counter] = simulate(K,1)[[2]]
    counter = counter + 1
  }
  plot(y = ratio, x = seq(0.8, 1.2, by = 0.01), xlab = 'Trigger Rate')
}
